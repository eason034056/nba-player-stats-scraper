# GitHub Actions Workflow: NBA Player Game Logs Scraper
# =====================================================
# é€™å€‹ workflow æœƒæ¯å¤©æ—©ä¸Š 6 é»ï¼ˆèŠåŠ å“¥æ™‚é–“ï¼‰è‡ªå‹•åŸ·è¡Œçˆ¬èŸ²
# ä¸¦å°‡æ›´æ–°çš„ CSV æª”æ¡ˆ commit å› repository

# name: workflow çš„åç¨±ï¼Œæœƒé¡¯ç¤ºåœ¨ GitHub Actions é é¢
name: NBA Player Game Logs Scraper

# on: å®šç¾©è§¸ç™¼ workflow çš„æ¢ä»¶
on:
  # schedule: å®šæ™‚åŸ·è¡Œï¼ˆä½¿ç”¨ cron èªæ³•ï¼‰
  schedule:
    # cron èªæ³•èªªæ˜ï¼šåˆ† æ™‚ æ—¥ æœˆ é€±
    # "0 12 * * *" çš„æ„æ€æ˜¯ï¼š
    #   - 0: ç¬¬ 0 åˆ†é˜
    #   - 12: ç¬¬ 12 å°æ™‚ï¼ˆUTC æ™‚é–“ï¼‰
    #   - *: æ¯å¤©
    #   - *: æ¯æœˆ
    #   - *: æ¯é€±çš„æ¯ä¸€å¤©
    # 
    # ã€é‡è¦ã€‘GitHub Actions ä½¿ç”¨ UTC æ™‚é–“ï¼
    # UTC 12:00 = èŠåŠ å“¥æ™‚é–“ (UTC-6 CST / UTC-5 CDT) 06:00
    # æ‰€ä»¥è¨­å®š 12 é» UTC = èŠåŠ å“¥æ—©ä¸Š 6 é»
    # è¨»ï¼šèŠåŠ å“¥ä½¿ç”¨æ—¥å…‰ç¯€ç´„æ™‚é–“ï¼Œå†¬å­£ UTC-6ï¼Œå¤å­£ UTC-5
    - cron: '0 12 * * *'
  
  # workflow_dispatch: å…è¨±æ‰‹å‹•è§¸ç™¼
  # é€™æ¨£ä½ å¯ä»¥åœ¨ GitHub ç¶²é ä¸Šæ‰‹å‹•åŸ·è¡Œæ¸¬è©¦
  workflow_dispatch:
    # inputs: å®šç¾©æ‰‹å‹•è§¸ç™¼æ™‚å¯ä»¥è¼¸å…¥çš„åƒæ•¸
    inputs:
      debug_enabled:
        type: boolean
        description: 'å•Ÿç”¨ debug æ¨¡å¼'
        required: false
        default: false

# jobs: å®šç¾©è¦åŸ·è¡Œçš„å·¥ä½œ
jobs:
  # scrape: å·¥ä½œçš„ IDï¼ˆè‡ªå®šç¾©åç¨±ï¼‰
  scrape:
    # name: å·¥ä½œçš„é¡¯ç¤ºåç¨±
    name: Scrape NBA Player Game Logs
    
    # runs-on: æŒ‡å®šåŸ·è¡Œç’°å¢ƒ
    # ubuntu-latest: ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ Ubuntu Linux
    runs-on: ubuntu-latest
    
    # timeout-minutes: è¨­å®šæœ€é•·åŸ·è¡Œæ™‚é–“ï¼ˆåˆ†é˜ï¼‰
    # å¢é‡æ¨¡å¼é€šå¸¸åªéœ€è¦ 30-60 åˆ†é˜ï¼Œä½†å®Œæ•´çˆ¬å–å¯èƒ½éœ€è¦ 4 å°æ™‚
    # GitHub Actions å…è²»ç‰ˆæœ€é•· 6 å°æ™‚
    timeout-minutes: 240
    
    # permissions: è¨­å®š GITHUB_TOKEN çš„æ¬Šé™
    # éœ€è¦ contents: write æ‰èƒ½ push æª”æ¡ˆåˆ° repository
    permissions:
      contents: write
    
    # steps: å®šç¾©åŸ·è¡Œæ­¥é©Ÿ
    steps:
      # ============================================================
      # æ­¥é©Ÿ 1: Checkout Repository
      # ============================================================
      # uses: ä½¿ç”¨ GitHub å®˜æ–¹æˆ–ç¤¾ç¾¤æä¾›çš„ action
      # actions/checkout@v4: å°‡ repository çš„ç¨‹å¼ç¢¼ä¸‹è¼‰åˆ°åŸ·è¡Œç’°å¢ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 è¡¨ç¤ºå–å¾—å®Œæ•´çš„ git æ­·å²
          # é€™å°æ–¼ commit æ“ä½œæ˜¯å¿…è¦çš„
          fetch-depth: 0
          # æ˜ç¢ºæŒ‡å®š tokenï¼Œé¿å…æ†‘è­‰ä¸ä¸€è‡´
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # ============================================================
      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      # ============================================================
      # actions/setup-python@v5: è¨­å®š Python ç’°å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          # python-version: æŒ‡å®š Python ç‰ˆæœ¬
          python-version: '3.11'
          # cache: å¿«å– pip å¥—ä»¶ï¼ŒåŠ é€Ÿå¾ŒçºŒåŸ·è¡Œ
          cache: 'pip'
      
      # ============================================================
      # æ­¥é©Ÿ 3: å®‰è£ Chrome ç€è¦½å™¨
      # ============================================================
      # é€™ä¸€æ­¥åœ¨ Ubuntu ç’°å¢ƒä¸­å®‰è£ Google Chrome
      # Selenium éœ€è¦å¯¦éš›çš„ç€è¦½å™¨ä¾†åŸ·è¡Œ
      - name: Install Chrome
        run: |
          # æ›´æ–°å¥—ä»¶åˆ—è¡¨
          sudo apt-get update
          # å®‰è£ wgetï¼ˆä¸‹è¼‰å·¥å…·ï¼‰
          sudo apt-get install -y wget
          # å¾ Google å®˜æ–¹ä¸‹è¼‰æœ€æ–°ç‰ˆ Chrome
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          # å®‰è£ Chromeï¼ˆ-y è‡ªå‹•åŒæ„ï¼Œ--fix-broken ä¿®å¾©ä¾è³´å•é¡Œï¼‰
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb --fix-broken
          # é¡¯ç¤º Chrome ç‰ˆæœ¬ï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
          google-chrome --version
      
      # ============================================================
      # æ­¥é©Ÿ 4: å®‰è£ Python ä¾è³´å¥—ä»¶
      # ============================================================
      - name: Install Python dependencies
        run: |
          # å‡ç´š pip åˆ°æœ€æ–°ç‰ˆæœ¬
          python -m pip install --upgrade pip
          # å®‰è£ requirements.txt ä¸­åˆ—å‡ºçš„æ‰€æœ‰å¥—ä»¶
          pip install -r requirements.txt
      
      # ============================================================
      # æ­¥é©Ÿ 5: åŸ·è¡Œçˆ¬èŸ²
      # ============================================================
      - name: Run Scraper
        # timeout-minutes: å–®ä¸€æ­¥é©Ÿçš„è¶…æ™‚æ™‚é–“
        # è¨­å®šç‚º 180 åˆ†é˜ï¼ˆ3 å°æ™‚ï¼‰ï¼Œçµ¦å®Œæ•´çˆ¬å–è¶³å¤ æ™‚é–“
        timeout-minutes: 180
        # continue-on-error: å³ä½¿çˆ¬èŸ²å¤±æ•—ï¼Œä¹Ÿç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ­¥é©Ÿ
        # é€™æ¨£å¯ä»¥ç¢ºä¿å·²æ”¶é›†çš„è³‡æ–™è¢«å„²å­˜
        continue-on-error: true
        id: scraper
        run: |
          # åŸ·è¡Œçˆ¬èŸ²è…³æœ¬
          python scrape_nba.py
        # env: è¨­å®šç’°å¢ƒè®Šæ•¸
        env:
          # PYTHONUNBUFFERED: è®“ Python è¼¸å‡ºä¸è¢«ç·©è¡
          # é€™æ¨£å¯ä»¥å³æ™‚çœ‹åˆ°è¼¸å‡º
          PYTHONUNBUFFERED: '1'
      
      # ============================================================
      # æ­¥é©Ÿ 6: ä¸Šå‚³æ—¥èªŒæª”æ¡ˆï¼ˆä½œç‚º artifactï¼‰
      # ============================================================
      # å³ä½¿çˆ¬èŸ²å¤±æ•—ï¼Œä¹Ÿä¸Šå‚³æ—¥èªŒä¾›é™¤éŒ¯
      - name: Upload logs
        uses: actions/upload-artifact@v4
        # if: always() è¡¨ç¤ºä¸ç®¡å‰é¢çš„æ­¥é©ŸæˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½åŸ·è¡Œé€™ä¸€æ­¥
        if: always()
        with:
          # name: artifact çš„åç¨±
          name: scrape-logs
          # path: è¦ä¸Šå‚³çš„æª”æ¡ˆ
          path: scrape_log.txt
          # retention-days: ä¿ç•™å¤©æ•¸
          retention-days: 7
      
      # ============================================================
      # æ­¥é©Ÿ 7: Commit ä¸¦ Push æ›´æ–°çš„ CSV æª”æ¡ˆ
      # ============================================================
      # å³ä½¿çˆ¬èŸ²éƒ¨åˆ†å¤±æ•—ï¼Œä¹Ÿå˜—è©¦å„²å­˜å·²æ”¶é›†çš„è³‡æ–™
      - name: Commit and Push changes
        if: always()
        run: |
          # è¨­å®š git ä½¿ç”¨è€…è³‡è¨Š
          # é€™æ˜¯ GitHub Actions bot çš„æ¨™æº–è¨­å®š
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å–å¾—ç•¶å‰æ—¥æœŸï¼ˆå°ç£æ™‚é–“ï¼‰
          # TZ='Asia/Taipei' è¨­å®šæ™‚å€
          # date '+%Y-%m-%d %H:%M:%S' æ ¼å¼åŒ–æ—¥æœŸ
          CURRENT_DATE=$(TZ='Asia/Taipei' date '+%Y-%m-%d %H:%M:%S')
          
          # æª¢æŸ¥ CSV æª”æ¡ˆæ˜¯å¦å­˜åœ¨
          if [ -f "nba_player_game_logs.csv" ]; then
            # åŠ å…¥ CSV æª”æ¡ˆåˆ° staging area
            git add nba_player_game_logs.csv
            
            # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦ commit
            if git diff --staged --quiet; then
              echo "æ²’æœ‰è®Šæ›´éœ€è¦ commit"
            else
              # æ ¹æ“šçˆ¬èŸ²åŸ·è¡Œçµæœæ±ºå®š commit è¨Šæ¯
              if [ "${{ steps.scraper.outcome }}" == "success" ]; then
                COMMIT_MSG="ğŸ“Š Update NBA player game logs - ${CURRENT_DATE}"
              else
                COMMIT_MSG="ğŸ“Š Partial update NBA player game logs - ${CURRENT_DATE} (éƒ¨åˆ†æˆåŠŸ)"
              fi
              
              # åŸ·è¡Œ commit
              git commit -m "${COMMIT_MSG}"
              # æ˜ç¢ºè¨­å®š remote ä½¿ç”¨ GITHUB_TOKEN
              git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
              # Push åˆ° repositoryï¼ˆæœ€å¤šé‡è©¦ 3 æ¬¡ï¼‰
              for attempt in 1 2 3; do
                if git push; then
                  break
                fi
                echo "âš ï¸ Push å¤±æ•—ï¼Œå°‡åœ¨ 5 ç§’å¾Œé‡è©¦ï¼ˆç¬¬ ${attempt} æ¬¡ï¼‰"
                sleep 5
              done
              echo "âœ“ å·²æˆåŠŸæ›´æ–°ä¸¦ push CSV æª”æ¡ˆ"
            fi
          else
            echo "âš ï¸ CSV æª”æ¡ˆä¸å­˜åœ¨ï¼Œè·³é commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ============================================================
      # æ­¥é©Ÿ 8: æª¢æŸ¥æœ€çµ‚ç‹€æ…‹
      # ============================================================
      - name: Check final status
        if: always()
        run: |
          if [ "${{ steps.scraper.outcome }}" == "success" ]; then
            echo "âœ… çˆ¬èŸ²åŸ·è¡ŒæˆåŠŸ"
            exit 0
          else
            echo "âš ï¸ çˆ¬èŸ²åŸ·è¡Œé‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
            # ä¸è¦è®“æ•´å€‹ workflow å¤±æ•—ï¼Œå› ç‚ºè³‡æ–™å¯èƒ½å·²ç¶“éƒ¨åˆ†æ›´æ–°
            exit 0
          fi
